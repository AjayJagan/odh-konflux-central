  - name: provision-eaas-space-predictor
    runAfter:
      - audit-snapshot
    taskRef:
      resolver: git
      params:
        - name: url
          value: https://github.com/konflux-ci/build-definitions.git
        - name: revision
          value: main
        - name: pathInRepo
          value: task/eaas-provision-space/0.1/eaas-provision-space.yaml
    params:
      - name: ownerName
        value: $(context.pipelineRun.name)
      - name: ownerUid
        value: $(context.pipelineRun.uid)

  - name: provision-cluster-predictor
    runAfter:
      - provision-eaas-space-predictor
    taskSpec:
      results:
        - name: clusterName
          value: "$(steps.create-cluster.results.clusterName)"
      steps:
        - name: get-supported-versions
          ref:
            resolver: git
            params:
              - name: url
                value: https://github.com/konflux-ci/build-definitions.git
              - name: revision
                value: main
              - name: pathInRepo
                value: stepactions/eaas-get-supported-ephemeral-cluster-versions/0.1/eaas-get-supported-ephemeral-cluster-versions.yaml
          params:
            - name: eaasSpaceSecretRef
              value: $(tasks.provision-eaas-space-predictor.results.secretRef)
        - name: pick-version
          ref:
            resolver: git
            params:
              - name: url
                value: https://github.com/konflux-ci/build-definitions.git
              - name: revision
                value: main
              - name: pathInRepo
                value: stepactions/eaas-get-latest-openshift-version-by-prefix/0.1/eaas-get-latest-openshift-version-by-prefix.yaml
          params:
            - name: prefix
              value: "$(steps.get-supported-versions.results.versions[0])."
        - name: create-cluster
          ref:
            resolver: git
            params:
              - name: url
                value: https://github.com/konflux-ci/build-definitions.git
              - name: revision
                value: main
              - name: pathInRepo
                value: stepactions/eaas-create-ephemeral-cluster-hypershift-aws/0.1/eaas-create-ephemeral-cluster-hypershift-aws.yaml
          params:
            - name: eaasSpaceSecretRef
              value: $(tasks.provision-eaas-space-predictor.results.secretRef)
            - name: version
              value: "$(steps.pick-version.results.version)"
            - name: instanceType
              value: m5.2xlarge


  - name: e2e-predictor
    runAfter:
      - provision-cluster-predictor
    params:
    - name: git-url
      value: "$(tasks.parse-metadata.results.source-git-url)"
    - name: git-rev
      value: "$(tasks.parse-metadata.results.target-git-branch)"
    - name: component-image
      value: "$(tasks.parse-metadata.results.component-container-image)"
    taskSpec:
      params:
        - name: git-url
          type: string
        - name: git-rev
          type: string
        - name: component-image
          type: string
      volumes:
        - name: credentials
          emptyDir: {}
      steps:
        - name: get-kubeconfig
          ref:
            resolver: git
            params:
              - name: url
                value: https://github.com/konflux-ci/build-definitions.git
              - name: revision
                value: main
              - name: pathInRepo
                value: stepactions/eaas-get-ephemeral-cluster-credentials/0.1/eaas-get-ephemeral-cluster-credentials.yaml
          params:
            - name: eaasSpaceSecretRef
              value: $(tasks.provision-eaas-space-predictor.results.secretRef)
            - name: clusterName
              value: "$(tasks.provision-cluster-predictor.results.clusterName)"
            - name: credentials
              value: credentials

        - name: clone-repo
          image: alpine/git
          script: |
            echo $(params.git-url)
            echo $(params.git-rev)
            git clone --depth 1 --branch $(params.git-rev) $(params.git-url) /workspace/source
            git config --global --add safe.directory /workspace/source
            cd /workspace/source

        - name: e2e-predictor
          image: quay.io/rhoai/rhoai-task-toolset:kserve
          env:
            - name: KUBECONFIG
              value: "/credentials/$(steps.get-kubeconfig.results.kubeconfig)"
            - name: SNAPSHOT
              value: $(tasks.generate-snapshot.results.SNAPSHOT)
            - name: LLMISVC_CONTROLLER_IMAGE
              value: $(tasks.build-llmisvc-controller.results.IMAGE_REF)
            - name: SKLEARN_IMAGE
              value: $(tasks.build-sklearn-serving-runtime.results.IMAGE_REF)
            - name: CUSTOM_TRANSFORMER_IMAGE
              value: $(tasks.build-custom-transformer.results.IMAGE_REF)
            - name: CUSTOM_MODEL_GRPC_IMAGE
              value: $(tasks.build-custom-model-grpc.results.IMAGE_REF)
            - name: SUCCESS_200_ISVC_IMAGE
              value: $(tasks.build-success-200-isvc.results.IMAGE_REF)
            - name: ERROR_404_ISVC_IMAGE
              value: $(tasks.build-error-404-isvc.results.IMAGE_REF)
          workingDir: /workspace/source
          volumeMounts:
            - name: credentials
              mountPath: /credentials
          script: |
            set -euxo pipefail
            # apk add --no-cache bash make git curl \
            # && curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl" \
            # && install -o root -g root -m 0755 kubectl /usr/local/bin/kubectl \
            # && rm kubectl && bash
            bash

            COMPONENT_NAME=kserve-agent-ci
            export KSERVE_AGENT_IMAGE=$(jq -r --arg component_name "${COMPONENT_NAME}" '.[$component_name].image' <<< "${SNAPSHOT}")

            COMPONENT_NAME=kserve-controller-ci
            export KSERVE_CONTROLLER_IMAGE=$(jq -r --arg component_name "${COMPONENT_NAME}" '.[$component_name].image' <<< "${SNAPSHOT}")

            COMPONENT_NAME=kserve-router-ci
            export KSERVE_ROUTER_IMAGE=$(jq -r --arg component_name "${COMPONENT_NAME}" '.[$component_name].image' <<< "${SNAPSHOT}")

            COMPONENT_NAME=kserve-storage-initializer-ci
            export STORAGE_INITIALIZER_IMAGE=$(jq -r --arg component_name "${COMPONENT_NAME}" '.[$component_name].image' <<< "${SNAPSHOT}")

            export GITHUB_SHA=stable
            ./test/scripts/openshift-ci/run-e2e-tests.sh graph 2 raw

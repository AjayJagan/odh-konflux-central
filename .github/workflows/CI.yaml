name: ODH Konflu Ci Onboarder

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Repository name'
        required: true
        type: choice
        options:
          - caikit-nlp
          - caikit-tgis-serving
          - kuberay
          # Add all valid components here

      source_type:
        description: 'Select source folder'
        required: true
        type: choice
        options:
          - pipelines
          - pipelineruns

      release_branch:
        description: 'Target Release Branch'
        required: true
        type: string

      version:
        description: 'New version'
        required: true
        type: string

jobs:
  update-tekton-pipelines-and-create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      repository-projects: write

    steps:
      - name: Checkout OKC repository
        uses: actions/checkout@v4
        with:
          path: okc-repo

      - name: Generate GitHub App token
        id: app-token
        uses: getsentry/action-github-app-token@v2
        with:
          app_id: ${{ secrets.ODH_DEVOPS_APP_ID }}
          private_key: ${{ secrets.ODH_DEVOPS_APP_PRIVATE_KEY }}

      - name: Set environment variables
        run: |
          echo "REPOSITORY=opendatahub-io/${{ inputs.component }}" >> $GITHUB_ENV
          echo "OKC_FOLDER=${{ inputs.component }}" >> $GITHUB_ENV
          echo "SOURCE_TYPE=${{ inputs.source_type }}" >> $GITHUB_ENV

      - name: Prepare Tekton files
        run: |
          repo_folder="okc-repo/${SOURCE_TYPE}/${OKC_FOLDER}"
          echo "Using source type: ${SOURCE_TYPE}"
          echo "Using source path: ${repo_folder}"

          if [ ! -d "$repo_folder" ]; then
            echo "ERROR: $repo_folder does not exist!"
            exit 1
          fi

          mkdir -p extracted/.tekton
          find "$repo_folder" -type f -name "*push.yaml" -exec cp {} extracted/.tekton/ \;

          if [ -z "$(ls -A extracted/.tekton)" ]; then
            echo "ERROR: No *push.yaml files found in $repo_folder"
            exit 1
          fi

          if [ "${SOURCE_TYPE}" = "pipelines" ]; then
            echo "Applying substitutions for pipelines"
            find extracted/.tekton -type f -name "*.yaml" | while read file; do
              sed -i -E 's|\$\$OUTPUT_IMAGE_TAG\$\$|'"${{ inputs.version }}"'|g' "$file"
              sed -i -E 's|\$\$TARGET_BRANCH\$\$|'"${{ inputs.release_branch }}"'|g' "$file"
            done
          else
            echo "PipelineRuns selected — files copied without modification"
          fi

      - name: Prepare GitHub workflow files (pipelines only)
        if: inputs.source_type == 'pipelines'
        run: |
          src_dir="okc-repo/workflows/${{ inputs.component }}"
          dest_dir="extracted/.github/workflows"
          mkdir -p "$dest_dir"

          if [ -d "$src_dir" ]; then
            echo "Copying workflow files from $src_dir"
            find "$src_dir" -type f -name "*.yaml" -exec cp {} "$dest_dir/" \;

            find "$dest_dir" -type f -name "*.yaml" | while read file; do
              perl -0777 -i -pe 's/\$\$TARGET_BRANCH\$\$/'"${{ inputs.release_branch }}"'/g' "$file"
            done
          else
            echo "No workflows found for component — skipping"
          fi

      - name: Clone component repo and push changes
        run: |
          git clone https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${REPOSITORY} repo-workspace
          cd repo-workspace

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git fetch origin ${{ inputs.release_branch }}
          git checkout -B ${{ inputs.release_branch }} origin/${{ inputs.release_branch }}

          branch_name="appstudio-${{ inputs.component }}-${SOURCE_TYPE}-${{ inputs.version }}-$(date +%s)"
          echo "BRANCH_NAME=$branch_name" >> $GITHUB_ENV

          git checkout -B "$branch_name" ${{ inputs.release_branch }}

          mkdir -p .tekton
          rsync -av --delete ../extracted/.tekton/ .tekton/
          git add -f .tekton

          if [ "${SOURCE_TYPE}" = "pipelines" ] && [ -d "../extracted/.github/workflows" ]; then
            mkdir -p .github/workflows
            rsync -av ../extracted/.github/workflows/ .github/workflows/
            git add -f .github/workflows
          fi

          if git diff --cached --quiet; then
            echo "No changes to commit."
            echo "commit=false" >> $GITHUB_ENV
            exit 0
          fi

          git commit -m "Sync ${SOURCE_TYPE} Tekton files for version ${{ inputs.version }}"
          git push --set-upstream origin "$branch_name"
          echo "commit=true" >> $GITHUB_ENV

      - name: Create Pull Request
        if: env.commit == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh pr create \
            --repo "${REPOSITORY}" \
            --base "${{ inputs.release_branch }}" \
            --head "${BRANCH_NAME}" \
            --title "Sync ${SOURCE_TYPE} Tekton files (${ { inputs.version } })" \
            --body "This PR syncs **${SOURCE_TYPE}** Tekton files to branch **${{ inputs.release_branch }}**.
          
          - Pipelines: version and branch substitutions applied
          - PipelineRuns: copied as-is without modification"

name: ODH Konflux Release Onboarder

on:
  workflow_dispatch:
    inputs:
      component:
        description: 'Repository name'
        required: true
        type: choice
        options:
          - caikit-nlp
          - caikit-tgis-serving
          - codeflare-operator
          - data-science-pipelines-operator
          - data-science-pipelines
          - feast
          - fms-guardrails-orchestrator
          - guardrails-detectors
          - guardrails-regex-detector
          - ilab-on-ocp
          - kserve
          - kubeflow
          - kuberay
          - lm-evaluation-harness
          - ml-metadata
          - model-registry-operator
          - model-registry
          - modelmesh-runtime-adapter
          - modelmesh-serving
          - modelmesh
          - notebooks
          - opendatahub-operator
          - odh-dashboard
          - odh-model-controller
          - openvino_model_server
          - rest-proxy
          - text-generation-inference
          - training-operator
          - trustyai-explainability
          - trustyai-service-operator
          - vllm-orchestrator-gateway
          - llm-d-inference-scheduler
          - llm-d-routing-sidecar
          - llama-stack-k8s-operator
          - odh-data-science-pipelines-argo-argoexec
          - odh-data-science-pipelines-argo-workflowcontroller
          - odh-model-metadata-collection
          - kube-auth-proxy
          - llama-stack-provider-ragas
          - mlserver
          - trainer
          - mlflow
          - mlflow-operator
          - eval-hub
          - spark-operator
          # Add all valid components here
      pr_target_branch:
        description: 'Branch to open the PR against (e.g. master).'
        required: true
        type: string
      build_branch:
        description: 'Branch that images are built from (e.g. stable).'
        required: true
        type: string
      version:
        description: 'New version'
        required: true
        type: string

jobs:
  update-tekton-pipelines-and-create-pr:
    runs-on: ubuntu-latest

    permissions:
      contents: write
      pull-requests: write
      repository-projects: write

    steps:
      - name: Checkout OKC repository
        uses: actions/checkout@v4
        with:
          path: okc-repo

      - name: Generate github-app token
        id: app-token
        uses: getsentry/action-github-app-token@v2
        with:
          app_id: ${{ secrets.ODH_DEVOPS_APP_ID }}
          private_key: ${{ secrets.ODH_DEVOPS_APP_PRIVATE_KEY }}

      - name: Set environment variables
        run: |
          echo "REPOSITORY=opendatahub-io/${{ inputs.component }}" >> $GITHUB_ENV
          echo "OKC_FOLDER=${{ inputs.component }}" >> $GITHUB_ENV

      - name: Prepare Tekton files
        run: |
          set -euo pipefail
      
          repo_folder="okc-repo/pipelines/${OKC_FOLDER}"
          echo "Using pipeline path: $repo_folder"
      
          [ -d "$repo_folder" ] || { echo "ERROR: $repo_folder does not exist"; exit 1; }
      
          mkdir -p extracted/.tekton
          prepared_files=()
      
          shopt -s nullglob
          for src in "$repo_folder"/*push.yaml; do
            base="$(basename "$src")"
      
            # Copy first
            cp "$src" "extracted/.tekton/$base"
            dest="extracted/.tekton/$base"
      
            pipeline_name=$(yq e '.metadata.name' "$dest")
      
            if [[ "$pipeline_name" == *"-on-push" ]]; then
              release_name="${pipeline_name/-on-push/-on-release-push}"
              release_file="${base/-on-push.yaml/-release.yaml}"
      
              mv "$dest" "extracted/.tekton/$release_file"
              dest="extracted/.tekton/$release_file"
      
              yq e -i ".metadata.name = \"$release_name\"" "$dest"
      
              echo "Prepared release pipeline:"
              echo "  File : $release_file"
              echo "  Name : $release_name"
            else
              echo "Skipping (not -on-push): $base"
              rm -f "$dest"
              continue
            fi
      
            sed -i -E 's|\$\$OUTPUT_IMAGE_TAG\$\$|'"${{ inputs.version }}"'|g' "$dest"
            sed -i -E 's|\$\$TARGET_BRANCH\$\$|'"${{ inputs.build_branch }}"'|g' "$dest"
      
            prepared_files+=("$dest")
          done
      
          if [ "${#prepared_files[@]}" -eq 0 ]; then
            echo "ERROR: No pipelines prepared"
            exit 1
          fi
      
          printf "%s\n" "${prepared_files[@]}" > /tmp/prepared_tekton_files


      - name: Prepare GitHub workflow files (if applicable)
        run: |
          src_dir="okc-repo/workflows/${{ inputs.component }}"
          dest_dir="extracted/.github/workflows"
          mkdir -p "$dest_dir"

          if [ -d "$src_dir" ]; then
            echo "Copying workflow files from $src_dir to $dest_dir"
            find "$src_dir" -type f -name "*.yaml" -exec cp {} "$dest_dir/" \;

            echo "Updating $$TARGET_BRANCH$$ to ${{ inputs.build_branch }} in GitHub workflow files"
            find "$dest_dir" -type f -name "*.yaml" | while read file; do
            # Replace $$TARGET_BRANCH$$ with the build branch (the branch images are built from)
            perl -0777 -i -pe 's/\$\$TARGET_BRANCH\$\$/'"${{ inputs.build_branch }}"'/g' "$file"
          done
          else
            echo "No workflows directory found for component '${{ inputs.component }}'. Skipping."
          fi

      - name: Clone and push Tekton changes
        run: |
          git clone https://x-access-token:${{ steps.app-token.outputs.token }}@github.com/${REPOSITORY} repo
          cd repo
      
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
          git checkout -B "${{ inputs.pr_target_branch }}" "origin/${{ inputs.pr_target_branch }}"
      
          branch="appstudio-${{ inputs.component }}-${{ inputs.version }}-$(date +%s)"
          echo "BRANCH_NAME=$branch" >> $GITHUB_ENV
          git checkout -b "$branch"
      
          mkdir -p .tekton
      
          while read file; do
            f="$(basename "$file")"
            cp "../$file" ".tekton/$f"
            git add ".tekton/$f"
          done < /tmp/prepared_tekton_files
      
          if git diff --cached --quiet; then
            echo "No changes detected."
            echo "commit=false" >> $GITHUB_ENV
            exit 0
          fi
      
          if [ "${{ inputs.dry_run }}" = "true" ]; then
            echo "DRY RUN ENABLED â€” showing diff only"
            git diff --cached
            echo "commit=false" >> $GITHUB_ENV
            exit 0
          fi
      
          git commit -m "Prepare release Tekton pipelines for ${{ inputs.version }}"
          git push --set-upstream origin "$branch"
          echo "commit=true" >> $GITHUB_ENV


      - name: Create Pull Request
        if: env.commit == 'true'
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          gh pr create \
            --repo "${REPOSITORY}" \
            --base "${{ inputs.pr_target_branch }}" \
            --head "${BRANCH_NAME}" \
            --title "Update Tekton files to version ${{ inputs.version }}" \
            --body "This PR updates the \`output-image\` tags and CEL expressions in \`.tekton/\` to version \`${{ inputs.version }}\`.

          - **PR target branch:** \`${{ inputs.pr_target_branch }}\` (changes land here first)
          - **Build branch:** \`${{ inputs.build_branch }}\` (branch that images are built from)"
